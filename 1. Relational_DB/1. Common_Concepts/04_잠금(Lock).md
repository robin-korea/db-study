# [DB] 잠금 (Lock) 핵심 개념 정리

## 1. 잠금(Lock)이란?

**정의:** 여러 사용자가 동시에 같은 데이터를 접근할 때, 데이터의 **무결성과 일관성**을 지키기 위한 **독점적인 권리**.

-   **핵심 목적:** 트랜잭션의 4가지 특성 중 **고립성(Isolation)**을 보장하기 위한 핵심 메커니즘이다.
-   하나의 트랜잭션이 특정 데이터에 대해 작업을 하고 있을 때, 다른 트랜잭션이 해당 데이터에 접근하지 못하도록 막거나, 읽기만 가능하도록 제한하는 역할을 한다.

> **쉬운 예시: "화장실 한 칸"**
> -   화장실 한 칸(**데이터**)을 이용하는 사람(**트랜잭셔**)은 문을 잠근다(**Lock**).
> -   안에 사람이 있는 동안(Lock이 걸려있는 동안), 다른 사람은 들어갈 수 없다.
> -   사용이 끝나 문을 열고 나오면(Unlock), 다음 사람이 들어가서 다시 문을 잠글 수 있다.

---

## 2. 잠금의 종류: 공유 잠금 vs 배타적 잠금

잠금은 다른 트랜잭션이 얼마나 접근할 수 있는지에 따라 크게 두 종류로 나뉜다.

### ① 공유 잠금 (Shared Lock, Read Lock)

-   **기능:** 데이터를 **읽기(SELECT)** 위해 사용하는 잠금.
-   **특징:**
    -   공유 잠금이 걸려있는 데이터는 다른 트랜잭션도 **똑같이 공유 잠금을 걸고 읽는 것이 가능**하다.
    -   하지만, 다른 트랜잭션이 해당 데이터를 **수정(UPDATE, DELETE)하려고 배타적 잠금을 거는 것은 불가능**하다.
-   **요약:** "나 지금 읽고 있으니까, 너도 읽는 건 괜찮아. 근데 내가 다 읽을 때까지 아무도 고치지는 마."

### ② 배타적 잠금 (Exclusive Lock, Write Lock)

-   **기능:** 데이터를 **수정하거나 삭제(INSERT, UPDATE, DELETE)**하기 위해 사용하는 잠금.
-   **특징:**
    -   배타적 잠금이 걸려있는 데이터는 다른 트랜잭션이 **공유 잠금(읽기)도, 배타적 잠금(쓰기)도 걸 수 없다.**
    -   오직 현재 잠금을 건 트랜잭션만 해당 데이터에 접근할 수 있다.
-   **요약:** "나 지금 이거 고치고 있으니까, 내 작업 끝날 때까지 아무도 읽지도, 건드리지도 마."

---

## 3. 잠금의 단위 (Lock Granularity)

잠금을 어느 범위까지 걸 것인지를 나타낸다. 범위가 작을수록 동시성은 좋아지지만, 관리(오버헤드)가 복잡해진다.

-   **테이블 잠금 (Table Lock):** 테이블 전체에 잠금을 거는 가장 큰 단위.
-   **페이지 잠금 (Page Lock):** 데이터가 저장되는 디스크의 페이지 단위로 잠금을 거는 방식.
-   **행 잠금 (Row Lock):** 하나의 행(Row)에만 잠금을 거는 가장 작은 단위. **InnoDB** 스토리지 엔진처럼 동시성 제어가 중요한 최신 DB 엔진에서 주로 사용된다.

---

## 4. 잠금으로 인해 발생하는 문제: 교착 상태 (Deadlock)

-   **정의:** 두 개 이상의 트랜잭션이 각각 자신의 잠금을 가진 상태에서, 서로가 가진 잠금을 획득하기 위해 **무한정 기다리는 상태.**
-   **발생 시나리오:**
    1.  트랜잭션 1이 A 데이터에 배타적 잠금을 건다.
    2.  트랜잭션 2가 B 데이터에 배타적 잠금을 건다.
    3.  트랜잭션 1이 B 데이터에 잠금을 걸려고 하지만, 트랜잭션 2가 이미 잠금을 걸고 있어서 기다린다.
    4.  트랜잭션 2가 A 데이터에 잠금을 걸려고 하지만, 트랜잭션 1이 이미 잠금을 걸고 있어서 기다린다.
    > -> 두 트랜잭션 모두 영원히 끝나지 못하고 서로를 기다리게 된다.

-   **해결책:**
    -   DBMS가 교착 상태를 감지하고, 둘 중 하나의 트랜잭션을 강제로 **ROLLBACK** 시킨다.
    -   애플리케이션 개발 시, 여러 테이블에 접근할 때 항상 **정해진 순서**로 접근하도록 규칙을 정해서 교착 상태 발생 확률을 줄인다.
