# [DB] 트랜잭션 (Transaction) 핵심 개념 정리

## 1. 트랜잭션이란?

**정의:** 데이터베이스의 상태를 변화시키는, 논리적으로 가장 작은 하나의 작업 단위.

-   여러 개의 쿼리(SELECT, INSERT, UPDATE, DELETE)가 모여 하나의 트랜잭션이 될 수 있다.
-   **핵심은 'All or Nothing'**: 모든 작업이 **전부 성공(Commit)**하거나, 하나라도 실패하면 **전부 실패(Rollback)**해야 한다.

**쉬운 예시: "계좌 이체"**
 1.  A 계좌에서 5,000원을 인출한다 (UPDATE).
 2.  B 계좌에 5,000원을 입금한다 (UPDATE).

이 두 작업은 반드시 하나의 트랜잭션으로 묶여야 한다. 1번만 성공하고 2번이 실패하면 돈이 사라지는 재앙이 발생하기 때문이다.

---

## 2. ACID: 트랜잭션의 4가지 핵심 특성

트랜잭션이 안전하고 신뢰성 있게 처리되기 위해 반드시 지켜야 할 4가지 원칙.

### ① 원자성 (Atomicity)

-   **All or Nothing.** 트랜잭션의 모든 연산은 전부 성공하거나, 전부 실패해야 한다.
-   작업 중 하나라도 실패하면, 이전의 모든 작업이 없었던 일처럼 **롤백(Rollback)** 되어야 한다.

### ② 일관성 (Consistency)

-   트랜잭션이 성공적으로 완료되면, 데이터베이스는 항상 **일관된(올바른) 상태**를 유지해야 한다.
-   데이터베이스에 정의된 규칙이나 제약조건(기본키, 외래키 등)을 위반해서는 안 된다.

### ③ 고립성 (Isolation)

-   하나의 트랜잭션이 실행 중일 때, 다른 트랜잭션이 끼어들어 영향을 줄 수 없다.
-   모든 트랜잭션은 **마치 혼자 실행되는 것처럼** 독립성을 보장받아야 한다.
-   이 고립성을 어느 수준까지 보장할 것인가가 바로 아래에 설명할 **'격리 수준(Isolation Level)'**이다.

### ④ 지속성 (Durability)

-   **커밋(Commit)** 되어 성공적으로 완료된 트랜잭션의 결과는 시스템에 **영구적으로 저장**되어야 한다.
-   데이터베이스 서버에 장애가 발생하거나 전원이 나가도, 완료된 트랜잭션의 결과는 사라지면 안 된다.

---

## 3. 트랜잭션 격리 수준 (Transaction Isolation Level)

> 고립성(Isolation)을 어느 정도로 보장할지 정하는 단계. **안정성**과 **성능** 사이의 트레이드오프 관계가 있다.

### 동시성 문제 (격리 수준이 낮을 때 발생)

-   **더티 리드 (Dirty Read):** 아직 Commit되지 않은 다른 트랜잭션의 수정 사항을 읽는 문제. (가장 심각)
-   **반복 불가능 읽기 (Non-Repeatable Read):** 한 트랜잭션 내에서 같은 데이터를 두 번 읽었는데, 그 사이에 값이 변경되어 결과가 다르게 나오는 문제.
-   **유령 읽기 (Phantom Read):** 한 트랜잭션 내에서 일정 범위의 데이터를 두 번 읽었는데, 그 사이에 없던 데이터가 유령처럼 새로 생겨나는 문제.

### 격리 수준의 4단계

| 수준 | 이름 | 설명 | 발생하는 문제 |
| :---: | :--- | :--- | :--- |
| **Lv 0** | **READ UNCOMMITTED (커밋되지 않은 읽기)** | Commit되지 않은 내용도 읽을 수 있음. | Dirty Read, Non-Repeatable Read, Phantom Read |
| **Lv 1** | **READ COMMITTED (커밋된 읽기)** | Commit된 내용만 읽을 수 있음.<br>**(대부분 DB의 기본값)** | Non-Repeatable Read, Phantom Read |
| **Lv 2**| **REPEATABLE READ (반복 가능한 읽기)** | 트랜잭션이 시작된 시점의 데이터를 읽음.<br>**(MySQL의 기본값)** | Phantom Read |
| **Lv 3** | **SERIALIZABLE (직렬화 가능)** | 가장 엄격. 트랜잭션을 순서대로 실행.<br>동시성이 거의 없음. | 없음 |

-   **위로 갈수록 성능이 좋지만, 데이터 부정합 문제가 발생할 수 있다.**
-   **아래로 갈수록 안전하지만, 동시 처리 성능이 떨어진다.**
